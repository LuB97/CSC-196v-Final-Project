<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>US Covid</title>
    <style>
        .background {
            fill: none;
            pointer-events: all;
        }

        .graticule {
            fill: none;
            stroke: #777;
            stroke-width: .5;
            stroke-opacity: .7;
        }

        #dma-borders {
            fill: none;
            stroke: black;
            stroke-width: 0.7;
            stroke-linejoin: round;
            stroke-linecap: round;
            pointer-events: none;
        }

        #textbox {
            position: relative;
            left: 1250px;
            bottom: -540px;
        }

        #textbox text p {
            font-family: "Lucida Sans Unicode";
            font-size: .8em;
            margin: 0;
        }

        .header {
            padding: 60px;
            text-align: left;
            background: url('COVID19_Banner.jpg');
            background-size: cover;
            opacity: 0.95;
            color: antiquewhite;
            font-size: 30px;
        }

        .center{
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }

        section.a{
            margin: 80px 400px;
        }

        /*margins are top right bottom left*/
        section.b{
            margin: -30px 0 0 20px;
        }

        section.c{
            margin: -50px 0 0 20px;
        }

        h3.map{
            margin: 20px 0 -30px 0;
        }

        h3.graph{
            margin: 20px 0 -30px 0;
        }

        h3.static{
            margin: 20px 0 -30px 0;
        }

        hr.a{
            margin: 10px 0 0 0;
        }

        h1{
            font-family: "Arial Black";
        }

        h2{
            font-family: Impact;
        }

        h3{
            font-family: "Lucida Sans Unicode";
        }

        p{
            font-family: "Lucida Sans Unicode";
        }

        p.note{
            font-family: "Lucida Sans Unicode";
            font-size: 12px;
            margin: 50px 0 50px 0 ;
        }

    </style>
</head>
<body>
<div class="header">
    <h1>COVID-19: <br/> Should States Reopen</h1>
</div>
<script src="https://d3js.org/d3.v3.js"></script>
<script>
    var d3v3 = window.d3;
    window.d3 = null;
</script>
<div>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script>
        var d3v4 = window.d3;
    </script>

    <!-- Color Scale -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://unpkg.com/d3-scale-cluster@1.3.1/dist/d3-scale-cluster.min.js"></script>

    <div id="textbox"></div>

    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <table>
        <tr>

        </tr>
    </table>
    <section>
        <h3 class = "map" align="Center">How has COVID-19 spread throughout the United States?</h3>
        <table align="Center" cellspacing="30">
            <th colspan="2">
                <hr class = "a">
            </th>
            <tr>
                <td>
                    <!-- Create a div where the map will take place -->
                    <div id="my_dataviz" align="center"></div>
                    <div class = "legend" style="margin: 0 0 0 1000px" id="legend1"></div>
                </td>
            </tr>
        </table>
    </section>
    <section class="c">

        <p class="note" align="Center">
            The map coloring shows the number of positive COVID-19 test results. <br>
            Hovering over the states shows details on the states COVID-19 numbers.
        </p>
    </section>

    <section>
        <h3 class = "static" align="Center">How does the number of positive results compare to the tests run in each state?</h3>
        <table align="Center" cellspacing="30" style="width: 1000px">
            <th>
                <hr class = "a">
            </th>
            <tr>
                <td>

                </td>
            </tr>
        </table>
        <img src="CovidStatic.png" width="800" height="700" class="center">
    </section>
    <section class="b">

        <p class="note" align="Center">
            The size of the circles shows the amount of testing that the state has done compared to other states. <br>
            The color of the circles represent the number of positive cases.
        </p>
    </section>

    <section style="margin: 50px 0 0 0">
        <h3 class = "graph" align="Center">What percent of the population has been tested for COVID-19 in the US?</h3>
        <table align="Center" cellspacing="20" >
            <th colspan="2">
                <hr class = "a">
            </th>
            <tr>
                <td>
                    <!-- Create a div where the graph will take place -->
                    <div id="main">
                        <div id="chart"></div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="sequence"></div>
                    <div id="explanation" style="visibility: hidden;" >
                        <span id="percentage"></span><br/>
                    </div>
                </td>

            </tr>
        </table>
    </section>


    <section class = "a">
        <h2 align="Center" >Data Analysis</h2>
        <hr>
        <p>
            For this project, Bryant and I wanted to explore whether or not reopening the states would be a logical
            move to make. We first examined the data in regards to how COVID has spread throughout the United States
            to date. From the first map visual, you can see that there are a number of states, such as California,
            New York, Texas, and Florida, that have been heavily affected by COVID.
            From there, we decided it would be a good idea to look into how many people were tested for COVID in each
            state and the number or test results that actually returned positive. In our visual we annotated two states;
            New York, because of the high number of positive results that they have seen and California, because that is
            most relevant to us. The visual showed us that although some states may have a high positive number, it is
            small in comparison to the number of people that have been tested. A good example of this would be California,
            where over 700,000 people have been tested but only about 55,000 of those results came back positive.
            This seemed like evidence that certain states would have reason to be safe for reopening. However, we
            decided to explore deeper into the data and we compared the number of tests performed to the actual population
            of the state. A large state like California seems like it has COVID under control. But after analysis we saw
            that the 700,000 tests performed equivalates to only 1.92% of the entire population. This means that 98% of
            the state could potentially be positive or asymptomatic. The analysis of just a single state already shows
            that the United States is not yet equip to reopen their states. More testing would have to be made available
            and efficiently performed in order to safely reopen states without creating the possibility of a major
            spike and quickly overburdening hospitals.
        </p>

        <h2 align="Center">Visualization</h2>
        <hr>
        <h3>
            How did you choose your particular visual encoding and interaction techniques?
        </h3>
        <p>
            With the novel virus COVID-19 spreading at an exponential rate around the globe, we wanted to focus on
            how it has been affecting us as a country in the Untied States. However, with the recent talk about
            states wanting to reopen, we wanted to explore whether or not this made sense. The media is always
            throwing a bunch of numbers at the public but without any context they do not amount to much. So we
            wanted to select interactions such as those in the sunburst to give a relation to testing and the
            population of each state. This way people would have a better understanding of how COVID has been
            recognized in their community and state.
        </p>
        <h3>
            What alternatives did you consider and how did you arrive at your ultimate choices
        </h3>
        <p>
            At first we had considered only showing the most recent data for each state. Then we would break out
            the details for each state in a textbox as you hovered over the state of your choice. But then we
            realized that the most recent data does not help to show people how quickly COVID-19 has progressed.
            So we decided to add an additional visual that graphically shows how COVID-19 has progressed overtime.
            We considered showing the over progression throughout the entire country, but we realized again that
            it would be most beneficial to show the progression through each state individually. This way viewers
            can more evidently see how quickly COVID-19 has spread in certain states. By showing the data as a
            whole country, certain states with more spread would affect the overall curve therefore potentially
            skewing how COVID-19 has affect states individually.
        </p>

        <h2 align="Center" >Development</h2>
        <hr>
        <h3>
            Roughly how much time did you spend developing your application?
        </h3>
        <p>
            Bryant and I had spent about 1 hour deciding what our story would be about. After that we had taken
            about 3 hours each to go out and find additional data in regards to COVID-19.
            Once we had gathered possible options we spent about 1 hour together deciding which sets of data would
            be useful most useful to our story and how we would present the data in our visualizations.
            After that, we spent about 1 hour for the data wrangling and deciding how to split up the data for
            our two new visualizations. The HTML and D3 set up took about 11 hrs each totaling to 22 hours in
            total for this. Our overall project took approximately 30 hours to completely develop
        </p>
        <h3>
            What aspects took the most time?
        </h3>
        <p>
            Figuring out how to create the sunburst chart took quite a bit of time. But the largest portion of our
            time was spent on making it look more aesthetically pleasing. Because there are 50 states that we are
            trying to show, it first looked cluttered and confusing. But once we added in the zooming and cleaned it
            up with better borders and coloring, it came out quite nice.
            The other aspect that was difficult was figuring out the best visuals and datasets to create a cohesive
            story showing why it would be best to not yet reopen states. Also to show what states can do in order to
            better prepare themselves for reopening.
        </p>
    </section>


    <script type="text/javascript">
        var w = 300, h = 50;

        var key = d3.select("#legend1")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var legend = key.append("defs")
            .append("svg:linearGradient")
            .attr("id", "gradient")
            .attr("x1", "0%")
            .attr("y1", "100%")
            .attr("x2", "100%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

        legend.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#FFE5E5")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "20%")
            .attr("stop-color", "#FFCCCC")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "40%")
            .attr("stop-color", "#FFB2B2")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "60%")
            .attr("stop-color", "#FF9999")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#FF7F7F")
            .attr("stop-opacity", 1);


        key.append("rect")
            .attr("width", w)
            .attr("height", h - 30)
            .style("fill", "url(#gradient)")
            .attr("transform", "translate(0,10)");

        var y = d3.scaleLinear()
            .range([300, 0])
            .domain([1100000, 0]);
        var yAxis = d3.axisBottom()
            .scale(y)
            .ticks(4);

        key.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(0,30)")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("axis title");
    </script>
    <script>
        <!------------------ map code---------------- !-->
        var width2 = 960,
            height2= 500;
        // sets the type of view
        var projection = d3v3.geo.albersUsa()
            .scale(1070) // size, bigger is bigger
            .translate([width2 / 2, height2 / 2]);

        //creates a new geographic path generator
        var path = d3v3.geo.path().projection(projection);
        var xScale = d3v3.scale.linear()
            .domain([0, 7])
            .range([0, 500]);

        var xAxis = d3v3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .tickSize(13)
            .tickFormat(d3.format("0.0f"));


        //set svg window
        var svg2 = d3v3.select("#my_dataviz")
            .append("svg")
            .attr("width", width2)
            .attr("height", height2);

        var graticule = d3v3.geo.graticule()
            .extent([[-98 - 45, 38 - 45], [-98 + 45, 38 + 45]])
            .step([5, 5]);

        // adding a blank background
        svg2.append("rect")
            .datum(graticule)
            .attr("class", "background")
            .attr("width", width2)
            .attr("height", height2)
        // .on("click", clicked);

        //declare g as our appended svg
        var g = svg2.append("g");

        var defaultFill = "#aaa";
        var scale;

        d3v3.json("us.json", function(error, us) {

            var state = us.objects.states.geometries;
            var domain = [];
            // adding data from tv json (number of TVs, etc) to map json
            d3v3.json("Covid.json", function(error, covid){
                for (var i = 0; i < state.length; i++){
                    var state_id = state[i].id;
                    state[i].properties = {};
                    for (key in covid[state_id]){
                        if(key == "Total Test Results"){
                            domain.push(covid[state_id]["Positive"])
                        }
                        state[i].properties[key] = covid[state_id][key];
                    }
                }
                us.objects.states.geometries = state;
                scale = d3.scaleCluster()
                    .domain(domain)
                    .range(['#FFE5E5', '#FFCCCC', '#FFB2B2', '#FF9999','#FF7F7F', '#FF4C4C']);
                g.append("g")
                    .attr("id", "us")
                    .attr("stroke","white")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.states).features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", function(d) {
                        color = scale(parseInt(d.properties["Total Test Results"]));
                        return color; })
                    .on("mouseover", mouseover1)

                    .on("mouseout", mouseout)
                    .attr("opacity", 0.9)
                    .attr("fill", defaultFill);
            })
        })
        function mouseover1(d){
            try{
                var prop = d.properties;

                var string =  "<p><strong>State</strong>: " + prop.State + "</p>";
                string += "<p><strong>Total Test Results</strong>: " + prop["Total Test Results"] + "</p>";
                string += "<p><strong>Positive</strong>: " + prop["Positive"] + "</p>";
                string += "<p><strong>Negative</strong>: " + prop["Negative"] + "</p>";
                if(prop.Hospitalized == null){
                    string += "<p><strong>Hospitalized</strong>: " + "N/A" + "</p>";
                }
                else {
                    string += "<p><strong>Hospitalized</strong>: " + prop["Hospitalized"] + "</p>";
                }
                string += "<p><strong>Death</strong>: " + prop["Death"] + "</p>";

                d3v3.select("#textbox")
                    .html("")
                    .append("text")
                    .html(string)

                d3v3.select(this)
                    .style("fill", "blueviolet");
            }catch(err){
                mouseover(d);
            }
        };
        function mouseout (d){
            d3v3.select(this)
                .style("fill", function(d) {
                    var color = scale(parseInt(d.properties["Total Test Results"])); // '#9E58AF'
                    return color; })
        };
        // via http://stackoverflow.com/a/2901298
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        var json;
        var nodes;
        var cur;
        // Dimensions of sunburst.
        var width = 700;
        var height = 600;
        var radius = Math.min(width, height) / 2;

        // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
        var b = {
            w: 95, h: 30, s: 3, t: 10
        };

        // Mapping of step names to colors.  #8585e0, #EAADEA, #C6E2FF, #c8ace5, #0986c7
        var colors = {
            "Alabama": "#c8ace5",
            "Alaska": "#EAADEA",
            "Arizona": "#c8ace5",
            "Arkansas": "#BDA0CB",
            "California": "#8585e0",
            "Colorado": "#EAADEA",
            "Connecticut": "#0986c7",
            "Delaware": "#0986c7",
            "Florida": "#C6E2FF",
            "Georgia": "#C6E2FF",
            "Hawaii": "#0986c7",
            "Idaho": "#c8ace5",
            "Illinois": "#0986c7",
            "Indiana": "#8585e0",
            "Iowa": "#8585e0",
            "Kansas": "#C6E2FF",
            "Kentucky": "#8585e0",
            "Louisiana": "#0986c7",
            "Maine": "#EAADEA",
            "Maryland": "#c8ace5",
            "Massachusetts": "#0986c7",
            "Michigan": "#0986c7",
            "Minnesota": "#8585e0",
            "Mississippi": "#C6E2FF",
            "Missouri": "#C6E2FF",
            "Montana": "#c8ace5",
            "Nebraska": "#EAADEA",
            "Nevada": "#0986c7",
            "New Hampshire": "#8585e0",
            "New Jersey": "#8585e0",
            "New Mexico": "#8585e0",
            "New York": "#c8ace5",
            "North Carolina": "#c8ace5",
            "North Dakota": "#C6E2FF",
            "Ohio": "#EAADEA",
            "Oklahoma": "#c8ace5",
            "Oregon": "#EAADEA",
            "Pennsylvania": "#8585e0",
            "Rhode Island": "#C6E2FF",
            "South Carolina": "#C6E2FF",
            "South Dakota": "#8585e0",
            "Tennessee": "#EAADEA",
            "Texas": "#EAADEA",
            "Utah": "#EAADEA",
            "Vermont": "#c8ace5",
            "Virginia": "#EAADEA",
            "Washington": "#C6E2FF",
            "West Virginia": "#C6E2FF",
            "Wisconsin": "#0986c7",
            "Wyoming": "#0986c7",
            "Tested": "#90EE90",
            "Untested": "#86d8e0",
            "Negative": "#54a2d4",
            "Positive": "#FFCCCB"
        };

        // Total size of all segments; we set this later, after loading the data.
        var totalSize = 0;

        var vis = d3v3.select("#chart").append("svg:svg")
            .attr("width", width)
            .attr("height", height)
            .append("svg:g")
            .attr("id", "container")
            .attr("stroke","white")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")

        var partition = d3v3.layout.partition()
            .size([2 * Math.PI, radius * radius])
            .value(function(d) { return d.size; });

        var arc = d3v3.svg.arc()
            .startAngle(function(d) { return d.x; })
            .endAngle(function(d) { return d.x + d.dx; })
            .innerRadius(function(d) { return Math.sqrt(d.y); })
            .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

        // Use d3v3.text and d3v3.csv.parseRows so that we do not need to have a header
        // row, and can receive the csv as an array of arrays.
        d3v3.text("Sunburst.csv", function(text) {
            var csv = d3v3.csv.parseRows(text);
            json = buildHierarchy(csv);
            createVisualization(json);
        });

        // Main function to draw and set up the visualization, once we have the data.
        function createVisualization(json) {

            // Basic setup of page elements.
            initializeBreadcrumbTrail();

            // Bounding circle underneath the sunburst, to make it easier to detect
            // when the mouse leaves the parent g.
            vis.append("svg:circle")
                .attr("r", radius)
                .style("opacity", 0)
                .on("click", ret);

            nodes = partition.nodes(json)

            var path = vis.data([json]).selectAll("path")
                .data(nodes)
                .enter().append("svg:path")
                .attr("display", function(d) { return d.depth ? null : "none"; })
                .attr("d", arc)
                .attr("fill-rule", "evenodd")
                .style("fill", function(d) { return colors[d.name]; })
                .style("opacity", 1)
                .on("mouseover", mouseover1)
                .on("click",click);

            cur = nodes[0];
            d3v3.select("#current").text("US")
            // Add the mouseleave handler to the bounding circle.
            d3v3.select("#container").on("mouseleave", mouseleave);
        };

        // Fade all but the current sequence, and show it in the breadcrumb trail.
        function mouseover(d) {
            var percentage = (100 * d.value / d.parent.value).toPrecision(3);
            var percentageString = percentage + "%";
            if (percentage < 0.1) {
                percentageString = "< 0.1%";
            }

            d3v3.select("#percentage")
                .text(percentageString);

            var description = "";
            var par = d.parent;
            if (par.name == "root") {
                description = d.name + " makes up " + percentageString + " of the US population";
            } else if (d.name == "Untested") {
                description = percentageString + " of " + par.name + "'s population is untested";
            } else if (d.name == "Tested") {
                description = percentageString + " of " + par.name + "'s population is tested";
            } else if (d.name == "Negative") {
                description = percentageString + " of " + par.parent.name + "'s tests are Negative";
            } else if (d.name == "Positive") {
                description = percentageString + " of " + par.parent.name + "'s tests are Positive";
            }


            d3v3.select("#explanation")
                .text(description)
                .style("visibility", "");

            var sequenceArray = getAncestors(d);
            updateBreadcrumbs(sequenceArray, percentageString);

            // Fade all the segments.
            d3v3.selectAll("path")
                .style("opacity", 0.3);

            // Then highlight only those that are an ancestor of the current segment.
            vis.selectAll("path")
                .filter(function (node) {
                    return (sequenceArray.indexOf(node) >= 0);
                })
                .style("opacity", 1);
        }

        function click(p) {
            if(p.name == "Negative" || p.name == "Positive" || p.name == "Untested"){
                cur = p.parent;
            }
            else{
                cur = p;
            }
            vis.selectAll("*").remove();

            vis.append("svg:circle")
                .attr("r", radius)
                .style("opacity", 0)
                .on("click", ret);

            nodes = partition.nodes(cur)

            var path = vis.data([cur]).selectAll("path")
                .data(nodes)
                .enter().append("svg:path")
                .attr("display", function(d) { return d.depth ? null : "none"; })
                .attr("d", arc)
                .attr("fill-rule", "evenodd")
                .style("fill", function(d) { return colors[d.name]; })
                .style("opacity", 1)
                .on("mouseover", mouseover1)
                .on("click",click);

            var string;
            if(p.name == "Tested"){
                string = p.parent.name + "'s Test Results";
            }
            else if(p.name == "Untested"){
                string = p.parent.name
            }
            else if(p.name == "Negative" || p.name == "Positive"){
                string = p.parent.parent.name + "'s Test Results";
            }
            else{
                string = p.name;
            }
            d3.select("#current").text(string);
        }
        function ret() {
            if(cur.name != "root"){
                cur = cur.parent;
            }
            vis.selectAll("*").remove();

            vis.append("svg:circle")
                .attr("r", radius)
                .style("opacity", 0)
                .on("click", ret);

            nodes = partition.nodes(cur)

            var path = vis.data([cur]).selectAll("path")
                .data(nodes)
                .enter().append("svg:path")
                .attr("display", function(d) { return d.depth ? null : "none"; })
                .attr("d", arc)
                .attr("fill-rule", "evenodd")
                .style("fill", function(d) { return colors[d.name]; })
                .style("opacity", 1)
                .on("mouseover", mouseover1)
                .on("click",click);

            var string;
            if(cur.name == "Tested"){
                string = cur.parent.name + "'s Test Results";
            }
            else if(cur.name == "Untested"){
                string = cur.parent.name
            }
            else if(cur.name == "Negative" || cur.name == "Positive"){
                string = cur.parent.parent.name + "'s Test Results";
            }
            else if(cur.name == "root"){
                string = "US";
            }
            else{
                string = cur.name;
            }
            d3.select("#current").text(string);
        }

        // Restore everything to full opacity when moving off the visualization.
        function mouseleave(d) {

            // Hide the breadcrumb trail
            d3v3.select("#trail")
                .style("visibility", "hidden");

            // Deactivate all segments during transition.
            d3v3.selectAll("path").on("mouseover", null);

            // Transition each segment to full opacity and then reactivate it.
            d3v3.selectAll("path")
                .transition()
                .duration(1000)
                .style("opacity", 1)
                .each("end", function() {
                    d3v3.select(this).on("mouseover", mouseover1);
                });

            d3v3.select("#explanation")
                .style("visibility", "hidden");
        }

        // Given a node in a partition layout, return an array of all of its ancestor
        // nodes, highest first, but excluding the root.
        function getAncestors(node) {
            var path = [];
            var current = node;
            while (current.parent) {
                path.unshift(current);
                current = current.parent;
            }
            return path;
        }

        function initializeBreadcrumbTrail() {
            // Add the svg area.
            var trail = d3v3.select("#sequence").append("svg:svg")
                .attr("width", width)
                .attr("height", 50)
                .attr("id", "trail");
            // Add the label at the end, for the percentage.
            trail.append("svg:text")
                .attr("id", "endlabel")
                .style("fill", "#000");
        }

        // Generate a string that describes the points of a breadcrumb polygon.
        function breadcrumbPoints(d, i) {
            var points = [];
            points.push("0,0");
            points.push(b.w + ",0");
            points.push(b.w + b.t + "," + (b.h / 2));
            points.push(b.w + "," + b.h);
            points.push("0," + b.h);
            if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
                points.push(b.t + "," + (b.h / 2));
            }
            return points.join(" ");
        }

        // Update the breadcrumb trail to show the current sequence and percentage.
        function updateBreadcrumbs(nodeArray, percentageString) {

            // Data join; key function combines name and depth (= position in sequence).
            var g = d3v3.select("#trail")
                .selectAll("g")
                .data(nodeArray, function(d) { return d.name + d.depth; });

            // Add breadcrumb and label for entering nodes.
            var entering = g.enter().append("svg:g");

            entering.append("svg:polygon")
                .attr("points", breadcrumbPoints)
                .style("fill", function(d) { return colors[d.name]; });

            entering.append("svg:text")
                .attr("x", (b.w + b.t) / 2)
                .attr("y", b.h / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(function(d) { return d.name; });

            // Set position for entering and updating nodes.
            g.attr("transform", function(d, i) {
                return "translate(" + i * (b.w + b.s) + ", 0)";
            });

            // Remove exiting nodes.
            g.exit().remove();

            // Now move and update the percentage at the end.
            d3v3.select("#trail").select("#endlabel")
                .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
                .attr("y", b.h / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(percentageString);

            // Make the breadcrumb trail visible, if it's hidden.
            d3v3.select("#trail")
                .style("visibility", "");

        }

        // Take a 2-column CSV and transform it into a hierarchical structure suitable
        // for a partition layout. The first column is a sequence of step names, from
        // root to leaf, separated by hyphens. The second column is a count of how
        // often that sequence occurred.
        function buildHierarchy(csv) {
            var root = {"name": "root", "children": []};
            for (var i = 0; i < csv.length; i++) {
                var sequence = csv[i][0];
                var size = +csv[i][1];
                if (isNaN(size)) { // e.g. if this is a header row
                    continue;
                }
                var parts = sequence.split("-");
                var currentNode = root;
                for (var j = 0; j < parts.length; j++) {
                    var children = currentNode["children"];
                    var nodeName = parts[j];
                    var childNode;
                    if (j + 1 < parts.length) {
                        // Not yet at the end of the sequence; move down the tree.
                        var foundChild = false;
                        for (var k = 0; k < children.length; k++) {
                            if (children[k]["name"] == nodeName) {
                                childNode = children[k];
                                foundChild = true;
                                break;
                            }
                        }
                        // If we don't already have a child node for this branch, create it.
                        if (!foundChild) {
                            childNode = {"name": nodeName, "children": []};
                            children.push(childNode);
                        }
                        currentNode = childNode;
                    } else {
                        // Reached the end of the sequence; create a leaf node.
                        childNode = {"name": nodeName, "size": size};
                        children.push(childNode);
                    }
                }
            }
            return root;
        };
    </script>
</diV>
</body>
</html>
